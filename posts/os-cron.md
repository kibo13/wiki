## Планировщик задач CRON

**CRON** (**C**ommand **R**un **ON**) - программа для автоматического выполнения задач в определённое время. 
Эти задачи принято называть ***CRON Jobs***. Такой инструмент отлично подходит для регулярных бэкапов, 
мониторинга дискового пространства, отправки электронных писем, перезагрузки сервера и других различных задач. 

### Как работает CRON

Команды в **CRON** записываются и управляются в специальном файле `crontab`. 
Каждый профиль пользователя в системе может иметь собственный файл `crontab`, 
где составляются расписания задач, которые хранятся в `/var/spool/cron/`.

> В системах **Linux** имеется другой файл `crontab`, сохраненный в директории `/etc/`. Это системный файл `crontab`,
> где имеется дополнительное поле, определяющее, для какого профиля пользователя должна запускаться каждая команда **CRON**.

Для работы с планировщиком в системе есть ряд команд, помогающих решать основные задачи:

```sh
# показать список задач из конфигурационного файла
crontab -l

# удалить конфигурационный файл вместе со всеми запланированными задачами
crontab -r

# показать, когда в последний раз открывался конфигурационный файл
crontab -v

# открыть конфигурационный файл 
crontab -e
```

> Последняя команда автоматически запустит текстовый редактор и загрузит в него файл конфигурации **CRON**.
> После выхода из редактора, новая конфигурация будет установлена (вступит в силу) автоматически.

Каждая команда состоит из 6 колонок, разделяемых пробелами или табуляторами. 
Первые пять колонок задают время выполнения (`m` = Минута, `h` = Час, `dom` = День, `mon` = Месяц, `dow` = День недели),
в них может находиться: 

- целое число 
- список чисел, разделённых запятыми 
- диапазон чисел, разделённых дефисом, `*` или `/`

Последняя колонка интерпретируются как выполняемая команда (`command`).

```sh
m   h   dom mon dow command 
*   *   *   *   *   выполняемая команда
|   |   |   |   |
|   |   |   |   --- день недели (0—7) (воскресенье = 0 или 7)
|   |   |   ------- месяц (1—12)
|   |   ----------- день (1—31)
|   --------------- час (0—23)
------------------- минута (0—59)
```
### Примеры использования заданий

```sh
# запускать команду каждую минуту
* * * * * /usr/local/bin/php /home/login/html/cron.php  

# запускать команду каждые 15 минут
0,15,30,45 * * * * /usr/local/bin/php /home/login/html/cron.php  

# запускать команду каждые три часа в 0 минут
0 */3 * * * /usr/local/bin/php /home/login/html/cron.php  

# запускать команду по понедельникам в 1 час 15 минут ночи
15 1 * * 1 /usr/local/bin/php /home/login/html/cron.php  

# запускать команду каждый вторник, среду и четверг в 4:00.
0 4 * * 2-4 /usr/local/bin/php /home/login/html/cron.php  
```

### Ограничение доступа

С помощью файлов `cron.allow` и `cron.deny` можно ограничить доступ пользователям на использование команды `crontab`.
Эти файлы хранятся в директории `/etc/`. 

Если файл `cron.deny` существует, любой пользователь, который будет указан в нем, 
не будет иметь возможность менять файл `crontab`. 

Если `cron.allow` существует, то только пользователи, указанные в нем, будут иметь возможность изменять файлы `crontab`. 

Если оба файла существуют, и пользователь указан в каждом файле, файл `cron.allow` будет иметь приоритет над `cron.deny`, 
и этот пользователь сможет изменять файл `crontab`.

Например, чтобы запретить доступ для всех пользователей, а затем предоставить доступ пользователю **kibo**, 
необходимо использовать следующую последовательность команд:

```sh
sudo echo ALL >>/etc/cron.deny
sudo echo kibo >>/etc/cron.allow
```

Сначала закрываем доступ для всех пользователей, добавив `ALL` в `файл cron.deny`. 
Затем, добавив имя пользователя в файл `cron.allow`, предоставим пользователю **kibo** доступ к выполнению задач **CRON**.

> Если пользователь имеет права `sudo`, он может изменять файл `crontab` 
> другого пользователя с помощью следующей команды:

```sh
sudo crontab -u user -e
```

> Если `cron.deny` существует, и `user` добавлен в него, но не указан в файле `cron.allow`, 
> в таком случае появится ошибка после запуска предыдущей команды:

```sh
Output
The user user cannot use this program (crontab)
```

По умолчанию все пользователи имеют доступ к **CRON**, если не существует файлов `cron.allow` или `cron.deny`.

### Установка CRON

Почти все дистрибутивы **Linux** имеют ту или иную форму **CRON**, установленную по умолчанию. 
Но если по какой-либо причине в системе отсутствует **CRON**, его можно установить командой:

```sh
sudo apt install cron
```

Также необходимо убедиться, что он настроен для работы в фоновом режиме:

```sh
sudo systemctl enable cron
```

```sh
Output
Synchronizing state of cron.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable cron
```

После этого **CRON** будет установлен в системе и можно составлять расписание задач.